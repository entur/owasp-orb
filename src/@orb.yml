version: 2.1

description: |
  An orb for running OWASP vulnerability checks through Gradle

orbs:
  gradle: circleci/gradle@1.0.6

executors:
  default:
    docker:
      - image: circleci/openjdk:11-jdk-sid
        environment:
          TERM: dumb

commands:
  restore_owasp_cache:
    steps:
      - restore_cache:
          name: Restore OWASP cache
          keys:
            - cve-cache-{{ checksum "year" }}-{{ checksum "twelveWeeks" }}-{{ checksum "fourWeeks" }}-{{ checksum "week" }}-{{ checksum "day" }}-{{ checksum "twelveHoursOfDay" }}-{{ checksum "fourHoursOfDay" }}
            - cve-cache-{{ checksum "year" }}-{{ checksum "twelveWeeks" }}-{{ checksum "fourWeeks" }}-{{ checksum "week" }}-{{ checksum "day" }}-{{ checksum "twelveHoursOfDay" }}
            - cve-cache-{{ checksum "year" }}-{{ checksum "twelveWeeks" }}-{{ checksum "fourWeeks" }}-{{ checksum "week" }}-{{ checksum "day" }}
            - cve-cache-{{ checksum "year" }}-{{ checksum "twelveWeeks" }}-{{ checksum "fourWeeks" }}-{{ checksum "week" }}
            - cve-cache-{{ checksum "year" }}-{{ checksum "twelveWeeks" }}-{{ checksum "fourWeeks" }}
            - cve-cache-{{ checksum "year" }}-{{ checksum "twelveWeeks" }}
            - cve-cache-{{ checksum "year" }}
            - cve-cache
  store_owasp_cache:
    parameters:
      cve_data_directory:
        type: string
    steps:
      - save_cache:
          name: Save OWASP cache
          key: cve-cache-{{ checksum "year" }}-{{ checksum "twelveWeeks" }}-{{ checksum "fourWeeks" }}-{{ checksum "week" }}-{{ checksum "day" }}-{{ checksum "twelveHoursOfDay" }}-{{ checksum "fourHoursOfDay" }}
          paths:
            - <<parameters.cve_data_directory>>

  generate_cache_keys:
    steps:
      - run:
          name: Generate OWASP cache keys
          command: |
            echo $(date +"%Y") >> year
            echo $(( $(date +"%_j") / 84)) >> twelveWeeks
            echo $(( $(date +"%_j") / 28)) >> fourWeeks
            echo $(( $(date +"%_j") / 7)) >> week
            echo $(( $(date +"%_j"))) >> day
            echo $(( $(date +"%_H") / 12)) >> twelveHoursOfDay
            echo $(( $(date +"%_H") / 4)) >> fourHoursOfDay

jobs:
  owasp_dependency_check_analyze:
    parameters:
      executor:
        description: The name of custom executor to use
        type: executor
        default: default
      cve_data_directory:
        type: string
        default: "~/.owasp-dependency-check"
      reportPath:
        type: string
        default: build/reports/
    executor: <<parameters.executor>>
    steps:
      - checkout
      - generate_cache_keys
      - restore_owasp_cache
      - gradle/with_cache:
          steps:
            - run:
                name: Run OWASP Dependency Check for single-module project
                command: ./gradlew dependencyCheckAnalyze --info
      - gradle/collect_test_results:
          test_results_path: ""
          reports_path: <<parameters.reportPath>>
      - store_owasp_cache:
          cve_data_directory: <<parameters.cve_data_directory>>
  owasp_dependency_check_aggregate:
    parameters:
      executor:
        description: The name of custom executor to use
        type: executor
        default: default
      cve_data_directory:
        type: string
        default: "~/.owasp-dependency-check"
      reportPath:
        type: string
        default: build/reports/
    executor: <<parameters.executor>>
    steps:
      - checkout
      - generate_cache_keys
      - restore_owasp_cache
      - gradle/with_cache:
          steps:
            - run:
                name: Run OWASP Dependency Check for multi-module project
                command: ./gradlew dependencyCheckAggregate --info
      - gradle/collect_test_results:
          test_results_path: ""
          reports_path: <<parameters.reportPath>>
      - store_owasp_cache:
          cve_data_directory: <<parameters.cve_data_directory>>

